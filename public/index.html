
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dao De Code</title>
  <meta name="author" content="Eugene Platonov">

  
  <meta name="description" content="As you may know Redis allows you to pass a Lua script which will be executed on server side.
What great about it is that it will be executed &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://daodecode.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Dao De Code" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-45243409-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Dao De Code</a></h1>
  
    <h2>some thoughts and some code...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:daodecode.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/06/redis-lua-tips/">Redis Lua Tips</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-06T18:10:00-04:00" pubdate data-updated="true">Sep 6<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As you may know <a href="http://redis.io">Redis</a> <a href="http://redis.io/commands/EVAL">allows</a> you to pass a <a href="http://www.lua.org/">Lua</a> script which will be executed on server side.
What great about it is that it will be executed atomically, as Redis is single-threaded.  <br/>
Though beware of long-running scripts as they can hog the server.
 So what good can you do with Lua? Actually a lot, and here some simple use cases</p>

<h2>Count keys by pattern</h2>

<p>Sometimes you just want to know how many keys named by some pattern you have.
You can always run <a href="http://redis.io/commands/keys">KEYS</a> command, but it prints every single key,
so if you have thousands of them it can be pretty overwhelming.
  Instead you can use this simple command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EVAL "return #redis.call('KEYS', 'your pattern goes here')" 0</span></code></pre></td></tr></table></div></figure>


<p>For example, let&#8217;s say we have:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>127.0.0.1:6379&gt; KEYS *
</span><span class='line'>1) "daodecode:post:2:tags"
</span><span class='line'>2) "daodecode:post:12:tags"
</span><span class='line'>3) "daodecode:post:2:title"
</span><span class='line'>4) "daodecode:post:10:tags"
</span><span class='line'>5) "daodecode:post:10:title"
</span><span class='line'>6) "daodecode:post:12:title"</span></code></pre></td></tr></table></div></figure>


<p>let&#8217;s get number of keys with tags:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>127.0.0.1:6379&gt; EVAL "return #redis.call('KEYS', 'daodecode:post:*:tags')" 0
</span><span class='line'>(integer) 3</span></code></pre></td></tr></table></div></figure>


<p>You&#8217;ve got the idea&#8230;</p>

<h2>Set expiration only if it has not already been set</h2>

<p>Let&#8217;s say you get some events from somewhere, extract some info from the events and add it to a redis set.
And you want your set to expire at some point, so you want to set a <a href="http://redis.io/commands/ttl">ttl</a> for the set, but only once.
 Redis kindly creates a set key if it didn&#8217;t exist before.
 But if you send <a href="http://redis.io/commands/expire">EXPIRE</a> command along with every <a href="http://redis.io/commands/sadd">SADD</a> command,
 redis kindly overwrites existing ttl with the new value. Lua to the rescue:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EVAL "if (redis.call('TTL', KEYS[1]) == -1) then redis.call('EXPIRE', KEYS[1], ARGV[1]) end" 1 &lt;KEY_NAME&gt; &lt;TTL&gt;</span></code></pre></td></tr></table></div></figure>


<p>For example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>127.0.0.1:6379&gt; SADD s1 m1
</span><span class='line'>(integer) 1
</span><span class='line'>127.0.0.1:6379&gt; TTL s1
</span><span class='line'>(integer) -1
</span><span class='line'>127.0.0.1:6379&gt; EXPIRE s1 30
</span><span class='line'>(integer) 1
</span><span class='line'>127.0.0.1:6379&gt; TTL s1
</span><span class='line'>(integer) 22
</span><span class='line'>127.0.0.1:6379&gt; EXPIRE s1 30
</span><span class='line'>(integer) 1
</span><span class='line'>127.0.0.1:6379&gt; TTL s1
</span><span class='line'>(integer) 28
</span><span class='line'>.0.0.1:6379&gt; SADD s2 m1
</span><span class='line'>(integer) 1
</span><span class='line'>127.0.0.1:6379&gt; EVAL "if (redis.call('TTL', KEYS[1]) == -1) then redis.call('EXPIRE', KEYS[1], ARGV[1]) end" 1 s2 30
</span><span class='line'>(nil)
</span><span class='line'>127.0.0.1:6379&gt; TTL s2
</span><span class='line'>(integer) 27
</span><span class='line'>127.0.0.1:6379&gt; EVAL "if (redis.call('TTL', KEYS[1]) == -1) then redis.call('EXPIRE', KEYS[1], ARGV[1]) end" 1 s2 30
</span><span class='line'>(nil)
</span><span class='line'>127.0.0.1:6379&gt; TTL s2
</span><span class='line'>(integer) 20</span></code></pre></td></tr></table></div></figure>


<p>Here you can see that we reset ttl for <code>s1</code>, but for <code>s2</code> we set ttl only for the first time, the second request didn&#8217;t change it</p>

<h2>Add members to a sorted set only once</h2>

<p>Redis gives us <a href="http://redis.io/commands#sorted_set">sorted sets</a> where we can add members along with scores associated with the members.
If you <a href="http://redis.io/commands/zadd">ZADD</a> a member which already exists in the set its score is overwritten.
It could happen that you may want to add a member only once. The easy way is to check if member doesn&#8217;t exist with
<a href="http://redis.io/commands/zscore">ZSCORE</a> command.
But running those two commands is not an atomic action and <a href="http://en.wikipedia.org/wiki/Race_condition">races</a> are possible. Lua is here again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='lua'><span class='line'><span class="k">if</span> <span class="ow">not</span> <span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">ZSCORE&#39;</span><span class="p">,</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>    <span class="k">then</span> <span class="k">return</span> <span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">ZADD&#39;</span><span class="p">,</span> <span class="n">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ARGV</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">return</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='lua'><span class='line'><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="n">ZADD</span> <span class="n">s1</span> <span class="mi">1</span> <span class="n">m1</span>
</span><span class='line'><span class="p">(</span><span class="n">integer</span><span class="p">)</span> <span class="mi">1</span>
</span><span class='line'><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="n">ZSCORE</span> <span class="n">s1</span> <span class="n">m1</span>
</span><span class='line'><span class="s2">&quot;</span><span class="s">1&quot;</span>
</span><span class='line'><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="n">ZADD</span> <span class="n">s1</span> <span class="mi">2</span> <span class="n">m1</span>
</span><span class='line'><span class="p">(</span><span class="n">integer</span><span class="p">)</span> <span class="mi">0</span>
</span><span class='line'><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="n">ZSCORE</span> <span class="n">s1</span> <span class="n">m1</span>
</span><span class='line'><span class="s2">&quot;</span><span class="s">2&quot;</span>
</span><span class='line'><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="n">EVAL</span> <span class="s2">&quot;</span><span class="s">if not redis.call(&#39;ZSCORE&#39;, KEYS[1], ARGV[1]) then return redis.call(&#39;ZADD&#39;, KEYS[1], ARGV[2], ARGV[1]) else return 0 end;&quot;</span> <span class="mi">1</span> <span class="n">s1</span> <span class="n">m1</span> <span class="mi">3</span>
</span><span class='line'><span class="p">(</span><span class="n">integer</span><span class="p">)</span> <span class="mi">0</span>
</span><span class='line'><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="n">ZSCORE</span> <span class="n">s1</span> <span class="n">m1</span>
</span><span class='line'><span class="s2">&quot;</span><span class="s">2&quot;</span>
</span><span class='line'><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="n">EVAL</span> <span class="s2">&quot;</span><span class="s">if not redis.call(&#39;ZSCORE&#39;, KEYS[1], ARGV[1]) then return redis.call(&#39;ZADD&#39;, KEYS[1], ARGV[2], ARGV[1]) else return 0 end;&quot;</span> <span class="mi">1</span> <span class="n">s1</span> <span class="n">m2</span> <span class="mi">3</span>
</span><span class='line'><span class="p">(</span><span class="n">integer</span><span class="p">)</span> <span class="mi">1</span>
</span><span class='line'><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="n">ZSCORE</span> <span class="n">s1</span> <span class="n">m2</span>
</span><span class='line'><span class="s2">&quot;</span><span class="s">3&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we add a member <code>m1</code> to set <code>s1</code> with score <code>1</code>, then we add it again with score <code>2</code>. ZSCORE reveals that the score has been changed.
Then with Lua script we add <code>m1</code> with score <code>3</code>, but only if ZSCORE returns <code>nil</code>, which is not true an as such doesn&#8217;t change the score of <code>m1</code>.
But for new member <code>m2</code> with score <code>3</code> it works.</p>

<p>These are only 3 simple use cases, but you can find it useful for many other things.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/29/call-scala-curried-functions-from-java/">Call Scala Curried Functions From Java</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-29T13:40:00-04:00" pubdate data-updated="true">Apr 29<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For some reason I thought scala curried functions is one of the features you will have troubles using from Java. But it happens that you can perfectly call a curried Scala function</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">class</span> <span class="nc">A</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">curried</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">toInt</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>from Java</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">new</span> <span class="nf">A</span><span class="o">().</span><span class="na">curried</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="s">&quot;7&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/18/sbt-plugins-no-default-package-please/">Sbt Plugins: No Default Package Please</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-18T16:46:00-05:00" pubdate data-updated="true">Feb 18<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Usually people don&#8217;t put sbt builds in a package (I&#8217;m talking about scala files here), especially for simple and small projects.
And they easily can use all the sbt plugins. <br/>
But there are other users who have bigger and more complex builds.
So they put their builds in packages and then they discover they can use only plugins which themselves defined in packages. Bummer!</p>

<p>Scala, as well as Java, does allow classes in <a href="http://docs.oracle.com/javase/specs/jls/se7/html/jls-7.html#jls-7.4.2">default or unnamed</a> package, but those classes can be accessed within default package only.
There is literally <a href="http://docs.oracle.com/javase/specs/jls/se7/html/jls-7.html#jls-7.5">no way</a> to import a class from default package.
Thus when someone creates an sbt plugin and puts it in default package, (s)he makes owners of packaged builds
 feel almost physical pain when they try to use the plugin.</p>

<p>So if you are an author of an sbt plugin, please consider to put it into a package. Doing otherwise violates
<a href="https://github.com/sbt/sbt/blob/0.13/src/sphinx/Extending/Plugins-Best-Practices.rst#dont-use-default-package">best practices</a>
 and makes God to kill a kitten.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/04/override-a-list-property-for-typesafe-config/">Override a List Property for Typesafe Config</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-04T19:39:00-05:00" pubdate data-updated="true">Feb 4<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today I naively was trying to override a list property for a unit test with the following code</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">System</span><span class="o">.</span><span class="n">setProperty</span><span class="o">(</span><span class="s">&quot;list.property&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;&quot;[ &quot;val1&quot;, &quot;val2&quot;]&quot;&quot;&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The tested code is reading the list property using <a href="https://github.com/typesafehub/config">typesafe config</a> library</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">listProperty</span> <span class="k">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getListString</span><span class="o">.</span><span class="n">asScala</span><span class="o">.</span><span class="n">toSet</span>
</span></code></pre></td></tr></table></div></figure>


<p>That was throwing
<code>com.typesafe.config.ConfigException$WrongType: system properties: list.property has type STRING rather than LIST</code></p>

<p>so I&#8217;ve googled a <a href="https://github.com/typesafehub/config/issues/69">solution</a> for overriding list properties from
command line, which is same for overriding in code</p>

<p>Here is how it looks now</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">System</span><span class="o">.</span><span class="n">setProperty</span><span class="o">(</span><span class="s">&quot;list.property.0&quot;</span><span class="o">,</span> <span class="s">&quot;val1&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nc">System</span><span class="o">.</span><span class="n">setProperty</span><span class="o">(</span><span class="s">&quot;list.property.1&quot;</span><span class="o">,</span> <span class="s">&quot;val2&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/27/reactivemongo-macros-and-nosuchelementexception-none-get/">ReactiveMongo, Macros and NoSuchElementException: None.get</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-27T20:40:00-04:00" pubdate data-updated="true">Oct 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://reactivemongo.org/">ReactiveMongo</a> employs <a href="http://scalamacros.org/">scala macros</a>
 to generate readers(deserializers) and writers(serializers)
for scala case classes. They work pretty good, but sometimes you can get a
<code>java.lang.NoSuchElementException</code> with message <code>None.get</code> :(</p>

<p>Let&#8217;s say you have</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="o">(</span><span class="n">fisrtName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">lastName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">age</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">readers</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">personReader</span> <span class="k">=</span> <span class="nc">Macros</span><span class="o">.</span><span class="n">reader</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and somewhere in your code you use it</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">readers._</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="k">def</span> <span class="n">findByFirstName</span><span class="o">(</span><span class="n">fName</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">personCollection</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="nc">BSONDocument</span><span class="o">(</span><span class="s">&quot;firstName&quot;</span> <span class="o">-&gt;</span> <span class="n">fName</span><span class="o">)).</span><span class="n">one</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>if your data is correct you are good, but let&#8217;s say you have some corrupted documents, for example <code>Joe</code> doesn&#8217;t have last name</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">find</span><span class="o">().</span><span class="n">pretty</span><span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s">&quot;_id&quot;</span> <span class="k">:</span> <span class="kt">ObjectId</span><span class="o">(</span><span class="err">&quot;526</span><span class="kt">ecf6f7e04ab5f2d1a12ba</span><span class="err">&quot;</span><span class="o">),</span>
</span><span class='line'>  <span class="s">&quot;firstName&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">Eugene</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;lastName&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">Platonov</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;age&quot;</span> <span class="k">:</span> <span class="err">27</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s">&quot;_id&quot;</span> <span class="k">:</span> <span class="kt">ObjectId</span><span class="o">(</span><span class="err">&quot;526</span><span class="kt">ecf817e04ab5f2d1a12bb</span><span class="err">&quot;</span><span class="o">),</span>
</span><span class='line'>  <span class="s">&quot;firstName&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">Joe</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;age&quot;</span> <span class="k">:</span> <span class="err">23</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>findByFirstName("Eugene")</code> will return Future of Success, but <code>findByFirstName("Joe")</code>
will return you Future of Failure with ugly <code>java.util.NoSuchElementException: None.get</code> which
points to the line where your macro-generated reader is defined.</p>

<p>Here is another, even more interesting, but much harder to spot problem:</p>

<p>If you insert your person doc via mongo shell</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="o">({</span><span class="n">firstName</span><span class="k">:</span> <span class="err">&quot;</span><span class="kt">Eugene</span><span class="err">&quot;</span><span class="o">,</span> <span class="n">lastName</span><span class="k">:</span> <span class="err">&quot;</span><span class="kt">Platonov</span><span class="err">&quot;</span><span class="o">,</span> <span class="n">age</span><span class="k">:</span> <span class="err">27</span><span class="o">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>the type of <code>age</code> field will be &#8230; right, <a href="http://docs.mongodb.org/manual/core/shell-types/">Double</a>.
Despite that mongo shell will show you <code>"age" : 27</code> when you search for that document.
And again reactivemongo will throw a <code>NoSuchElementException</code> exception at you. Sigh.</p>

<p>To avoid it insert integers as <code>NumberInt</code>s</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="o">({</span><span class="n">firstName</span><span class="k">:</span> <span class="err">&quot;</span><span class="kt">Eugene</span><span class="err">&quot;</span><span class="o">,</span> <span class="n">lastName</span><span class="k">:</span> <span class="err">&quot;</span><span class="kt">Platonov</span><span class="err">&quot;</span><span class="o">,</span> <span class="n">age</span><span class="k">:</span> <span class="kt">NumberInt</span><span class="o">(</span><span class="err">27</span><span class="o">)})</span>
</span></code></pre></td></tr></table></div></figure>


<p>I think reactive mongo should be more explicit about what went wrong and hopefully
this will be <a href="https://github.com/ReactiveMongo/ReactiveMongo/pull/131">fixed soon</a>, but if not, you know where the dog lies buried.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/12/akka-stop-your-router-gracefully/">Akka: Stop Your Router Gracefully</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-12T23:34:00-04:00" pubdate data-updated="true">Jul 12<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Let&#8217;s say you want to find an answer to <a href="http://en.wikipedia.org/wiki/Answer_to_Life,_the_Universe,_and_Everything">Life, the Universe and Everything</a>
 and you know it will take some time,
 so you want to do it in parralel while doing something else (DSE).<br/>
You say to yourself &#8220;okay, I&#8217;ll fire an actor and send him a message or bunch of messages, then DSE and collect my results from the actor after i&#8217;m done&#8221;</p>

<p>So you&#8217;ve got it coded</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>  <span class="k">val</span> <span class="n">answerToLifeTheUniverseAndEverything</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">actor</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">Actor</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="n">i</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=&gt;</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">answerToLifeTheUniverseAndEverything</span><span class="o">.</span><span class="n">getAndIncrement</span><span class="o">()</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you want make it work and get results at the end. You need to make sure to access the result after all work is done.
From <a href="http://akka.io/docs/">akka documentation</a> you found out that <a href="http://doc.akka.io/api/akka/2.2.0/index.html#akka.pattern.GracefulStopSupport"><code>akka.pattern.GracefulStopSupport</code></a>
seems a good choice to do it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">42</span><span class="o">)</span> <span class="n">actor</span> <span class="o">!</span> <span class="n">i</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// DO SOMETHING ELSE</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">import</span> <span class="nn">akka.pattern.gracefulStop</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">gracefulStop</span><span class="o">(</span><span class="n">actor</span><span class="o">,</span> <span class="n">timeout</span><span class="o">),</span> <span class="n">timeout</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;We found the answer, it&#39;s ${answerToLifeTheUniverseAndEverything.get}&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>as a result you see</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">We</span> <span class="n">found</span> <span class="n">the</span> <span class="n">answer</span><span class="o">,</span> <span class="n">it</span><span class="-Symbol">&#39;s</span> <span class="mi">42</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nice!<br/>
But then you think &#8220;I can do it not only in parallel to my DSE, but compute it in many independent actors, so it will be done even faster&#8221;.
Using a router actor seems an easy way to do it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>  <span class="k">val</span> <span class="n">answerToLifeTheUniverseAndEverything</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">router</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">Actor</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="n">i</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=&gt;</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">answerToLifeTheUniverseAndEverything</span><span class="o">.</span><span class="n">getAndIncrement</span><span class="o">()</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}).</span><span class="n">withRouter</span><span class="o">(</span><span class="nc">RoundRobinRouter</span><span class="o">(</span><span class="n">nrOfInstances</span> <span class="k">=</span> <span class="mi">10</span><span class="o">)))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">42</span><span class="o">)</span> <span class="n">router</span> <span class="o">!</span> <span class="n">i</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// DO SOMETHING ELSE</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">import</span> <span class="nn">akka.pattern.gracefulStop</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">gracefulStop</span><span class="o">(</span><span class="n">router</span><span class="o">,</span> <span class="n">timeout</span><span class="o">),</span> <span class="n">timeout</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;We found the answer, it&#39;s ${answerToLifeTheUniverseAndEverything.get}&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Router sends messages to routees in round-robin fashion and routees do the work parallel to each other.
At the end you again see</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">We</span> <span class="n">found</span> <span class="n">the</span> <span class="n">answer</span><span class="o">,</span> <span class="n">it</span><span class="-Symbol">&#39;s</span> <span class="mi">42</span>
</span></code></pre></td></tr></table></div></figure>


<p>Super nice! You&#8217;re done! You can go and grab a milk shake. Or do you?  <br/>
Computing answer to Life, the Universe and Everything is a complex task, so it really should take some time and effort to calculate it.<br/>
Let&#8217;s add <code>Thread.sleep(1000)</code> pretending that our actor(or rather many actors) do something time consuming.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">i</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=&gt;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'>    <span class="n">answerToLifeTheUniverseAndEverything</span><span class="o">.</span><span class="n">getAndIncrement</span><span class="o">()</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then while you enjoing your shake all of a sudden you see</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">We</span> <span class="n">found</span> <span class="n">the</span> <span class="n">answer</span><span class="o">,</span> <span class="n">it</span><span class="-Symbol">&#39;s</span> <span class="mi">10</span>
</span></code></pre></td></tr></table></div></figure>


<p>What the hell?<br/>
The thing is <code>gracefullStop</code> sends a <code>PoisonPill</code> to an actor, which is a router in our case.
Once an actor gets to a <code>PoisonPill</code> message it decides to die and as a good parent, he can&#8217;t allow his children stay and suffer in this cruel world, so he kills them too.<br/>
&#8220;But <code>PoisonPill</code> will be the last message my router gets, right? So it dies after all other messages are processed.&#8221; you say.<br/>
Right, but processing a message from a router&#8217;s point of view is just to send it to one of its routees.<br/>
But then it dies when they still in progress and because the number of messages (42) is greater than number of routees (10) they all have more than one message to process.
So they do, until their <em>Daddy</em> comes and gets them to the <em>Land of Peace</em>. Their unprocessed messages are lost.
Thus the answer to Life, the Universe and Everything you get is 10. It can be different, but it usually will be around a number of routees.</p>

<p>So what is the solution?</p>

<p>The answer before akka 2.2 is don&#8217;t use <code>gracefulStop</code> with routers! (Of course you can take a look at the source code and make your own version of <code>gracefulStop</code>)
Since 2.2 you can specify stopMessage which is a <code>PoisonPill</code> by default. So the line will look like</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>  <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">gracefulStop</span><span class="o">(</span><span class="n">router</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="nc">PoisonPill</span><span class="o">)),</span> <span class="n">timeout</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now the answer is correct again :)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">We</span> <span class="n">found</span> <span class="n">the</span> <span class="n">answer</span><span class="o">,</span> <span class="n">it</span><span class="-Symbol">&#39;s</span> <span class="mi">42</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/19/debug-an-sbt-plugin-in-intellij-idea/">Debug an Sbt Plugin in IntelliJ IDEA</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-19T12:51:00-04:00" pubdate data-updated="true">Apr 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So you have your own sbt plugin (or someone&#8217;s plugin if you are not so cool and sexy) and you want to debug it.
It happens that there is nothing easier than that. If you run sbt through <a href="https://github.com/paulp/sbt-extras">sbt-extras</a> script (if you don&#8217;t you should)
just start your test sbt app with the plugin added to the build with the following command</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sbt -jvm-debug 5005</span></code></pre></td></tr></table></div></figure>


<p>You can use any port, I use 5005 because it&#8217;s a default port for remote debug configuration in <a href="http://www.jetbrains.com/idea/">IntelliJ IDEA</a> which I use for scala development.
And if you are cool and sexy, you know&#8230; :)</p>

<p>This is how your sbt console should look like after you start it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>jozic@laptop ~/projects/sbt-about-plugins $ sbt -jvm-debug 5005
</span><span class='line'>Detected sbt version 0.12.3
</span><span class='line'>Starting sbt: invoke with -help for other options
</span><span class='line'>Listening for transport dt_socket at address: 5005
</span><span class='line'>[info] Loading global plugins from /home/jozic/.sbt/plugins
</span><span class='line'>[info] Loading project definition from /home/jozic/projects/sbt-about-plugins/project
</span><span class='line'>[info] Set current project to sbt-about-plugins (in build file:/home/jozic/projects/sbt-about-plugins/)
</span><span class='line'>&gt;</span></code></pre></td></tr></table></div></figure>


<p>Then open your project in IDEA (you can generate IDEA project files using
<a href="https://github.com/mpeltonen/sbt-idea">sbt-idea</a> plugin) and create remote debug configuration.
<img src="/images/sbt-debug/idea.debug.configuration.png">
You can change port, but 5005 will do in our case, so you literaly can save default configuration.
Run it and you should get the following line in IDEA console:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Connected to the target VM, address: 'localhost:5005', transport: 'socket'</span></code></pre></td></tr></table></div></figure>


<p>After that put a breakpoint inside your plugin command, switch to sbt console, run your command and here you go!
<img src="/images/sbt-debug/idea.breakpoint.in.action.png"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/25/castgc-cookie-and-httponly-flag/">CASTGC Cookie and HttpOnly Flag</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-25T10:56:00-04:00" pubdate data-updated="true">Mar 25<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Let&#8217;s assume you employ <a href="http://www.jasig.org/cas">CAS</a> to be your single sign-on solution. Upon receiving correct credentials from the user CAS generates CASTGC cookie,
   which is marked with <a href="http://en.wikipedia.org/wiki/HTTP_cookie#Secure_and_HttpOnly">Secured</a> flag. And assume you want to add <a href="http://en.wikipedia.org/wiki/HTTP_cookie#Secure_and_HttpOnly">HttpOnly</a>
   flag to the cookie, to prevent accessing it <code>via non-HTTP methods</code>.
   CAS of version 3.5.0 depends on <a href="http://download.oracle.com/otndocs/jcp/servlet-2.5-mrel-eval-oth-JSpec/">servlet-api 2.5</a> and fancy <a href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/Cookie.html#setHttpOnly(boolean)">setHttpOnly</a>
   method has been added in version 3.0 of the servlet-api. So how do we deal with it?</p>

<p>Assuming you run your CAS in a servlet container based on <a href="http://download.oracle.com/otndocs/jcp/servlet-3.0-fr-oth-JSpec/">servlet 3.0 specification</a>
 (e.g. <a href="http://eclipse.org/jetty/">Jetty 8</a> or <a href="http://tomcat.apache.org/download-70.cgi">Tomcat 7</a>) and use <a href="http://maven.apache.org/">maven</a> as your build tool you can do the following to make it happen:</p>

<ol>
<li> exclude old (2.5 and lower) servlet-api jars from dependencies. For example

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>org.jasig.cas<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>cas-server-integration-restlet<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>${casVersion}<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;exclusions&gt;</span>
</span><span class='line'>        <span class="nt">&lt;exclusion&gt;</span>
</span><span class='line'>            <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;artifactId&gt;</span>servlet-api<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/exclusion&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/exclusions&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>
</li>
<li> include new servlet-api jar (notice that artifact id has been changed)

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>3.0.1<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>
</li>
<li> create your own version of <a href="https://github.com/Jasig/cas/blob/master/cas-server-webapp/src/main/java/org/jasig/cas/web/support/CookieRetrievingCookieGenerator.java">CookieRetrievingCookieGenerator</a>
which supports HttpOnly flag. You want to extend this class because CAS relies on it internally.

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">daodecode</span><span class="o">.</span><span class="na">cas</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">support</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.servlet.http.Cookie</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpOnlySupportingCookieGenerator</span>
</span><span class='line'>        <span class="kd">extends</span> <span class="n">org</span><span class="o">.</span><span class="na">jasig</span><span class="o">.</span><span class="na">cas</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">CookieRetrievingCookieGenerator</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">cookieHttpOnly</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCookieHttpOnly</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">cookieHttpOnly</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">cookieHttpOnly</span> <span class="o">=</span> <span class="n">cookieHttpOnly</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="n">Cookie</span> <span class="nf">createCookie</span><span class="o">(</span><span class="n">String</span> <span class="n">cookieValue</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">createCookie</span><span class="o">(</span><span class="n">cookieValue</span><span class="o">);</span>
</span><span class='line'>        <span class="n">cookie</span><span class="o">.</span><span class="na">setHttpOnly</span><span class="o">(</span><span class="n">cookieHttpOnly</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">cookie</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
</li>
<li> override TGT Cookie Generator creation providing your version of <code>ticketGrantingTicketCookieGenerator.xml</code>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;ticketGrantingTicketCookieGenerator&quot;</span>
</span><span class='line'>      <span class="na">class=</span><span class="s">&quot;com.daodecode.cas.web.support.HttpOnlySupportingCookieGenerator&quot;</span>
</span><span class='line'>    <span class="na">cookieSecure=</span><span class="s">&quot;${cas.cookie.secure}&quot;</span>
</span><span class='line'>    <span class="na">cookieHttpOnly=</span><span class="s">&quot;${cas.cookie.httponly}&quot;</span>
</span><span class='line'>    <span class="na">cookieMaxAge=</span><span class="s">&quot;-1&quot;</span>
</span><span class='line'>  <span class="na">cookieName=</span><span class="s">&quot;CASTGC&quot;</span>
</span><span class='line'>  <span class="na">cookiePath=</span><span class="s">&quot;${cas.cookie.path}&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>
</li>
</ol>


<p>done!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/08/testing-security-dot-authenticated-in-play-2-dot-0-and-2-dot-1/">Testing Security.Authenticated in Play 2.0 and 2.1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-08T21:00:00-05:00" pubdate data-updated="true">Mar 8<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>You have a <a href="http://www.playframework.com/">Play</a> application and let&#8217;s say you want to add some simple authentication logic to restrict access to your actions.
You want all your users to provide a ticket (e.g <a href="https://wiki.jasig.org/display/CAS/Proxy+CAS+Walkthrough">cas proxy ticket</a>)
in a request header, so you can use the ticket to authenticate them.</p>

<p>Play&#8217;s <a href="http://www.playframework.com/documentation/api/2.1.0/scala/index.html#play.api.mvc.Security$">Security.Authenticated</a>
to the rescue!</p>

<p>You can come up with something like this in Play 2.1:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">Secured</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">logger</span> <span class="k">=</span> <span class="nc">Logger</span><span class="o">(</span><span class="s">&quot;secured&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">final</span> <span class="k">def</span> <span class="n">fail</span><span class="o">(</span><span class="n">reason</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Access attempt failed: $reason&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="nc">Unauthorized</span><span class="o">(</span><span class="s">&quot;must be authenticated&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">final</span> <span class="k">def</span> <span class="n">secured</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">action</span><span class="k">:</span> <span class="kt">Action</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">=</span>
</span><span class='line'>    <span class="nc">Security</span><span class="o">.</span><span class="nc">Authenticated</span><span class="o">(</span>
</span><span class='line'>      <span class="n">req</span> <span class="k">=&gt;</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;authTicket&quot;</span><span class="o">),</span>
</span><span class='line'>      <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">fail</span><span class="o">(</span><span class="s">&quot;no ticket found&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">ticket</span> <span class="k">=&gt;</span> <span class="nc">Action</span><span class="o">(</span><span class="n">action</span><span class="o">.</span><span class="n">parser</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">request</span> <span class="k">=&gt;</span> <span class="n">withTicket</span><span class="o">(</span><span class="n">ticket</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">action</span><span class="o">(</span><span class="n">request</span><span class="o">)</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="k">def</span> <span class="n">withTicket</span><span class="o">(</span><span class="n">ticket</span><span class="k">:</span> <span class="kt">String</span><span class="o">)(</span><span class="n">produceResult</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">Result</span><span class="o">)</span><span class="k">:</span> <span class="kt">Result</span> <span class="o">=</span>
</span><span class='line'>    <span class="nc">Async</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">isValid</span><span class="o">(</span><span class="n">ticket</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">valid</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">valid</span><span class="o">)</span> <span class="n">produceResult</span> <span class="k">else</span> <span class="n">fail</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;provided ticket $ticket is invalid&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">isValid</span><span class="o">(</span><span class="n">ticket</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In Play 2.0 it looks almost same except that <code>isValid</code> returns <em>old</em> play&#8217;s <code>Promise</code> instead of scala&#8217;s <code>Future</code>.</p>

<p>And you can use it like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">securedAction</span> <span class="k">=</span> <span class="n">secured</span> <span class="o">{</span>
</span><span class='line'>  <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">request</span> <span class="k">=&gt;</span> <span class="nc">Ok</span><span class="o">(</span><span class="s">&quot;Am I protected?&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>All good, but how do we know it works? Test it!</p>

<p>Let&#8217;s create a fake controller which has both secured and non-secured actions. And we&#8217;ll use it in our tests, or rather <a href="http://etorreborre.github.com/specs2/">specs</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>  <span class="k">object</span> <span class="nc">FakeController</span> <span class="k">extends</span> <span class="nc">Controller</span> <span class="k">with</span> <span class="nc">Secured</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">securedAction</span> <span class="k">=</span> <span class="n">secured</span> <span class="o">{</span>
</span><span class='line'>      <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">request</span> <span class="k">=&gt;</span> <span class="nc">Ok</span><span class="o">(</span><span class="s">&quot;Am I protected?&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">nonSecuredAction</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">request</span> <span class="k">=&gt;</span> <span class="nc">Ok</span><span class="o">(</span><span class="s">&quot;I don&#39;t care&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">isValid</span><span class="o">(</span><span class="n">ticket</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Promise</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="n">ticket</span> <span class="o">==</span> <span class="s">&quot;valid&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To test that <code>authTicket</code> param is required we can have something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="s">&quot;return UNAUTHORIZED if `authTicket` param is not provided&quot;</span> <span class="n">in</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">running</span><span class="o">(</span><span class="n">app</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">FakeController</span><span class="o">.</span><span class="n">securedAction</span> <span class="n">process</span> <span class="nc">FakeRequest</span><span class="o">()</span>
</span><span class='line'>    <span class="n">status</span><span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="n">must_==</span> <span class="nc">UNAUTHORIZED</span>
</span><span class='line'>    <span class="n">contentAsString</span><span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="n">must_==</span> <span class="s">&quot;must be authenticated&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here <code>app</code> is a <a href="http://www.playframework.com/documentation/api/2.1.0/scala/index.html#play.api.test.FakeApplication">FakeApplication</a>
 and <code>process</code> is our method (added through implicits) which returns a <a href="http://www.playframework.com/documentation/api/2.1.0/scala/index.html#play.api.mvc.Result">Result</a>
  given a <a href="http://www.playframework.com/documentation/api/2.1.0/scala/index.html#play.api.mvc.Request">Request</a>.</p>

<p>Please note in Play 2.0 <code>status</code> and <code>contentAsString</code> don&#8217;t know how to handle <a href="http://www.playframework.com/documentation/api/2.1.0/scala/index.html#play.api.mvc.AsyncResult">AsyncResults</a>,
so with this implementation of <code>withTicket</code> you need to do some trible dance to make it work.</p>

<p>In Play 2.0 <code>Authenticated</code> returnes <code>Action[(Action[A], A)]</code> so our <code>process</code> looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">action2actionExecutor</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">wrapped</span><span class="k">:</span> <span class="kt">Action</span><span class="o">[(</span><span class="kt">Action</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>, <span class="kt">A</span><span class="o">)])</span><span class="k">:</span> <span class="kt">ActionExecutor</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</span><span class='line'>  <span class="k">=</span> <span class="k">new</span> <span class="nc">ActionExecutor</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">wrapped</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">ActionExecutor</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">wrapped</span><span class="k">:</span> <span class="kt">Action</span><span class="o">[(</span><span class="kt">Action</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>, <span class="kt">A</span><span class="o">)])</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">process</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Request</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Result</span> <span class="o">=</span> <span class="n">wrapped</span><span class="o">.</span><span class="n">parser</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">await</span><span class="o">.</span><span class="n">get</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">Left</span><span class="o">(</span><span class="n">errorResult</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">errorResult</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">Right</span><span class="o">((</span><span class="n">innerAction</span><span class="o">,</span> <span class="k">_</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">innerAction</span><span class="o">(</span><span class="n">request</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>in Play 2.1 we get just <a href="">EssentialAction</a> (and we can use <a href="">implicit class</a>) so it looks much simple:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>  <span class="k">implicit</span> <span class="k">class</span> <span class="nc">ActionExecutor</span><span class="o">(</span><span class="n">action</span><span class="k">:</span> <span class="kt">EssentialAction</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">process</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">request</span><span class="k">:</span> <span class="kt">Request</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Result</span> <span class="o">=</span>
</span><span class='line'>      <span class="n">concurrent</span><span class="o">.</span><span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">action</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="n">run</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">&quot;sec&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To test what happens if <code>authTicket</code> is provided but is not valid we can do the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">requestWithAuthTicket</span><span class="o">(</span><span class="n">ticket</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">&quot;invalid&quot;</span><span class="o">)</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">FakeRequest</span><span class="o">().</span><span class="n">withHeaders</span><span class="o">(</span><span class="s">&quot;authTicket&quot;</span> <span class="o">-&gt;</span> <span class="n">ticket</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="s">&quot;return UNAUTHORIZED if `authTicket` param is not valid&quot;</span> <span class="n">in</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">running</span><span class="o">(</span><span class="n">app</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">FakeController</span><span class="o">.</span><span class="n">securedAction</span> <span class="n">process</span> <span class="n">requestWithAuthTicket</span><span class="o">()</span>
</span><span class='line'>    <span class="n">status</span><span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="n">must_==</span> <span class="nc">UNAUTHORIZED</span>
</span><span class='line'>    <span class="n">contentAsString</span><span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="n">must_==</span> <span class="s">&quot;must be authenticated&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To make sure that it allows access when ticket is valid let&#8217;s add this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="s">&quot;return whatever it returns if `authTicket` param is valid&quot;</span> <span class="n">in</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">running</span><span class="o">(</span><span class="n">app</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">FakeController</span><span class="o">.</span><span class="n">securedAction</span> <span class="n">process</span> <span class="n">requestWithAuthTicket</span><span class="o">(</span><span class="n">ticket</span> <span class="k">=</span> <span class="s">&quot;valid&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">status</span><span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="n">must_==</span> <span class="nc">OK</span>
</span><span class='line'>    <span class="n">contentAsString</span><span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="n">must_==</span> <span class="s">&quot;Am I protected?&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Full source code can be found on <a href="https://github.com/jozic/play-security-authenticated-tests">github</a> in branches play20 and play20 correspondently.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/28/camel-and-scala-2-dot-10/">Camel and Scala 2.10</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-28T23:33:00-05:00" pubdate data-updated="true">Feb 28<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://camel.apache.org/">Camel</a> and <a href="http://www.scala-lang.org/">Scala</a> is a good combination,
but if you like to be on the bleeding edge and almost done converting your scala app to <a href="http://www.scala-lang.org/node/27499">2.10</a>
you can find that camel still doesn&#8217;t have a stable release supporting scala 2.10.
So SNAPSHOT will do the trick in this case, but you know&#8230; it&#8217;s a SNAPSHOT :)<br/>
All you need is apache snapshots repo and camel-scala 2.11-SNAPSHOT</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">resolvers</span> <span class="o">+=</span> <span class="s">&quot;Apache Snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;http://repository.apache.org/snapshots/&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">&quot;org.apache.camel&quot;</span> <span class="o">%</span> <span class="s">&quot;camel-scala&quot;</span> <span class="o">%</span> <span class="s">&quot;2.11-SNAPSHOT&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add those to your sbt build and you are all set.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/09/06/redis-lua-tips/">Redis Lua Tips</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/29/call-scala-curried-functions-from-java/">Call Scala curried functions from Java</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/18/sbt-plugins-no-default-package-please/">Sbt Plugins: No Default Package Please</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/04/override-a-list-property-for-typesafe-config/">Override a list property for Typesafe Config</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/27/reactivemongo-macros-and-nosuchelementexception-none-get/">ReactiveMongo, macros and  NoSuchElementException: None.get</a>
      </li>
    
  </ul>
</section>





<section>
  <h1>Categories</h1>
    <span id="tag-cloud"><a href='/blog/categories/akka' style='font-size: 106.66666666666667%'>akka</a> <a href='/blog/categories/camel' style='font-size: 106.66666666666667%'>camel</a> <a href='/blog/categories/cas' style='font-size: 106.66666666666667%'>cas</a> <a href='/blog/categories/idea' style='font-size: 106.66666666666667%'>idea</a> <a href='/blog/categories/java' style='font-size: 126.66666666666667%'>java</a> <a href='/blog/categories/lots-of-parens' style='font-size: 106.66666666666667%'>lots of parens</a> <a href='/blog/categories/lua' style='font-size: 106.66666666666667%'>lua</a> <a href='/blog/categories/mongo' style='font-size: 106.66666666666667%'>mongo</a> <a href='/blog/categories/play' style='font-size: 113.33333333333333%'>play</a> <a href='/blog/categories/racket' style='font-size: 106.66666666666667%'>racket</a> <a href='/blog/categories/reactivemongo' style='font-size: 106.66666666666667%'>reactivemongo</a> <a href='/blog/categories/redis' style='font-size: 106.66666666666667%'>redis</a> <a href='/blog/categories/router' style='font-size: 106.66666666666667%'>router</a> <a href='/blog/categories/sbt' style='font-size: 113.33333333333333%'>sbt</a> <a href='/blog/categories/scala' style='font-size: 160.0%'>scala</a> <a href='/blog/categories/typesafe-config' style='font-size: 106.66666666666667%'>typesafe-config</a> </span>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Eugene Platonov -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'daodecode';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
